<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Arts &amp; Media School Islington ‚Äì Homework Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --blue: #0052cc;
      --red: #e53935;
      --orange: #fb8c00;
      --green: #2e7d32;
      --dark: #0f172a;
      --light-bg: #f3f5fb;
      --border: #d5ddf1;
      --card: #ffffff;
    }

    [data-theme="dark"] {
      --blue: #3b82f6;
      --red: #ef4444;
      --orange: #f59e0b;
      --green: #10b981;
      --dark: #f3f4f6;
      --light-bg: #1f2937;
      --border: #374151;
      --card: #111827;
      background: #0f172a;
      color: #f3f4f6;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #eef2ff, #f9fafb 45%, #eef2ff 90%);
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
    }

    header {
      background: rgba(255, 255, 255, 0.94);
      border-bottom: 1px solid rgba(226, 232, 240, 0.8);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.04);
      padding: 12px 32px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      column-gap: 32px;
      row-gap: 6px;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 30;
      backdrop-filter: blur(16px);
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #22c55e, #3b82f6 55%, #ef4444 100%);
      box-shadow: 0 6px 14px rgba(37, 99, 235, 0.4);
    }

    .logo-text { display: flex; flex-direction: column; }

    .logo-main {
      font-weight: 700;
      font-size: 20px;
      color: var(--blue);
      letter-spacing: 0.02em;
    }

    .logo-sub {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #6b7280;
      margin-top: 2px;
    }

    .meta {
      font-size: 12px;
      text-align: right;
      color: #6b7280;
    }

    .meta strong { color: var(--dark); font-weight: 600; }

    /* Search and Filter Styles */
    .search-container {
      position: relative;
      display: flex;
      gap: 8px;
      margin-right: 8px;
    }

    .search-input {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card);
      color: var(--dark);
      font-size: 14px;
      width: 200px;
      transition: all 0.2s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }

    .advanced-filters {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-top: 8px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      z-index: 100;
      display: none;
    }

    .advanced-filters.visible {
      display: block;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      min-width: 150px;
    }

    .filter-group label {
      font-size: 12px;
      margin-bottom: 4px;
      color: var(--dark);
      opacity: 0.8;
    }

    .select-input,
    .date-input {
      padding: 6px 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--card);
      color: var(--dark);
      font-size: 14px;
    }

    .select-input:focus,
    .date-input:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }

    /* Make multi-select look better */
    select[multiple] {
      min-height: 80px;
      padding: 4px;
    }

    select[multiple] option {
      padding: 4px 8px;
      border-radius: 4px;
      margin: 2px 0;
    }

    select[multiple] option:checked {
      background-color: var(--blue);
      color: white;
    }

    /* Responsive adjustments */
    @media (max-width: 1200px) {
      .filter-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filter-group {
        width: 100%;
      }
      
      .search-container {
        width: 100%;
        margin-bottom: 8px;
      }
      
      .search-input {
        flex: 1;
      }
    }

    .btn {
      border: none;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: var(--blue);
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.35);
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
      white-space: nowrap;
    }

    .btn:hover {
      background: #0040a3;
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(37, 99, 235, 0.45);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.25);
    }

    .btn-light {
      background: #eff4ff;
      color: var(--blue);
      box-shadow: none;
      border: 1px solid #c3d4ff;
    }

    .btn-light:hover { background: #e0ebff; }

    .btn-outline {
      background: #ffffff;
      color: #0f172a;
      border: 1px solid rgba(148, 163, 184, 0.9);
      box-shadow: none;
      padding-inline: 18px;
    }

    .btn-ghost {
      background: transparent;
      color: #6b7280;
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      box-shadow: none;
      font-size: 12px;
      padding-inline: 14px;
    }

    .btn-ghost:hover {
      background: #eff4ff;
      color: var(--blue);
      border-style: solid;
    }

    main {
      max-width: 1800px;
      margin: 36px auto 48px;
      padding: 0 48px 48px;
    }

    .calendar {
      background: var(--card);
      border-radius: 26px;
      padding: 28px 36px 32px;
      border: 1px solid var(--border);
      box-shadow: 0 30px 60px rgba(15, 23, 42, 0.1);
    }

    .controls-row {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .controls-left {
      display: inline-flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .week-label {
      font-weight: 700;
      font-size: 16px;
      color: var(--dark);
      margin-left: auto;
      margin-right: 8px;
      white-space: nowrap;
    }

    .controls-right {
      display: inline-flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-left: auto;
      align-items: center;
    }

    .year-filter {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: #6b7280;
      cursor: pointer;
      transition: background 0.12s ease, color 0.12s ease, border-color 0.12s ease, box-shadow 0.12s ease;
    }

    .chip:hover { background: #eef2ff; border-color: #bfdbfe; }

    .chip.active {
      background: #1d4ed8;
      color: #e5ecff;
      border-color: #1d4ed8;
      box-shadow: 0 6px 14px rgba(37, 99, 235, 0.4);
    }

    .field { display: flex; flex-direction: column; font-size: 12px; color: #4b5563; }

    .field-label {
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 600;
      font-size: 11px;
      color: #9ca3af;
    }

    .field select,
    .field input,
    .field textarea {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 7px 12px;
      font-size: 13px;
      font-family: inherit;
      outline: none;
      min-width: 0;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      background: #f9fafb;
    }

    .field textarea {
      border-radius: 16px;
      resize: vertical;
    }

    .field select:focus,
    .field input:focus,
    .field textarea:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.35);
      background: #ffffff;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(280px, 1fr));
      gap: 36px;
      overflow-x: auto;
      padding-bottom: 12px;
    }

    .day-wrapper {
      display: flex;
      flex-direction: column;
      gap: 14px;
      min-width: 280px;
    }

    .day-header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 0 4px;
    }

    .day-header {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
      font-weight: 700;
    }

    .day-date {
      font-size: 13px;
      font-weight: 700;
      color: #111827;
    }

    .day-column {
      background: linear-gradient(180deg, #f9fbff, #f4f6fb);
      padding: 16px 14px;
      border-radius: 22px;
      border: 1px dashed rgba(191, 219, 254, 0.9);
      min-height: 280px;
      max-height: 480px;
      overflow-y: auto;
    }

    .homework-card {
      background: #ffffff;
      border-radius: 18px;
      padding: 18px 20px 20px;
      margin-bottom: 18px;
      border-left: 5px solid var(--blue);
      box-shadow: 0 14px 26px rgba(15, 23, 42, 0.14);
      position: relative;
    }

    .homework-subject {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--blue);
      letter-spacing: 0.12em;
      margin-right: 120px;
    }

    .homework-title {
      font-size: 16px;
      font-weight: 650;
      margin: 8px 0 6px;
    }

    .homework-meta {
      font-size: 12px;
      color: #6b7280;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    .homework-description {
      margin: 6px 0 0;
      font-size: 13px;
      color: #374151;
      cursor: pointer;
      transition: color 0.2s ease;
      padding: 4px 0;
      line-height: 1.5;
    }

    .homework-description:hover {
      color: var(--blue);
      text-decoration: underline;
    }

    .homework-description.expanded {
      font-size: 16px;
      line-height: 1.8;
      padding: 12px;
      background: #f8fafc;
      border-radius: 12px;
      border-left: 3px solid var(--blue);
      margin: 8px 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      cursor: default;
      text-decoration: none;
    }

    .homework-description.expanded:hover {
      color: #374151;
      text-decoration: none;
    }

    .homework-link { margin-top: 8px; }

    .homework-link a {
      font-size: 12px;
      text-decoration: none;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(37, 99, 235, 0.55);
      color: var(--blue);
      background: rgba(37, 99, 235, 0.05);
    }

    .homework-link a:hover { background: rgba(37, 99, 235, 0.12); }

    .empty-day {
      font-size: 12px;
      color: #9ca3af;
      padding: 10px 4px;
      font-style: italic;
      text-align: center;
    }

    .status-pill {
      position: absolute;
      top: 10px;
      right: 14px;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .status-overdue { background: rgba(229, 57, 53, 0.12); color: var(--red); border: 1px solid rgba(229, 57, 53, 0.6); }
    .status-soon    { background: rgba(251, 140, 0, 0.12); color: var(--orange); border: 1px solid rgba(251, 140, 0, 0.6); }
    .status-upcoming{ background: rgba(37, 99, 235, 0.08); color: var(--blue); border: 1px solid rgba(37, 99, 235, 0.6); }
    .status-today   { background: rgba(46, 125, 50, 0.12); color: var(--green); border: 1px solid rgba(46, 125, 50, 0.65); }

    .hint { margin-top: 12px; font-size: 12px; color: #6b7280; }

    #teacherPanel {
      margin-top: 32px;
      padding: 28px 32px 32px;
      background: var(--card);
      border-radius: 26px;
      border: 1px solid var(--border);
      box-shadow: 0 28px 55px rgba(15, 23, 42, 0.1);
      display: none;
    }

    #teacherPanel.active { display: block; }

    .teacher-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      font-size: 14px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .teacher-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
      gap: 40px;
      margin-top: 12px;
    }

    .card-form { margin-top: 12px; }
    
    #teacherPanel h2 {
      font-size: 22px;
      margin-bottom: 12px;
      margin-top: 0;
    }
    
    #teacherPanel h3 {
      font-size: 18px;
      margin-bottom: 16px;
      margin-top: 0;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px 24px;
    }

    .form-actions { margin-top: 14px; display: flex; align-items: center; }

    .status-text { font-size: 12px; margin-left: 8px; color: var(--blue); }
    .status-text.error { color: var(--red); }

    .teacher-homework-list {
      margin-top: 14px;
      max-height: 400px;
      overflow-y: auto;
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 12px 16px;
      background: linear-gradient(135deg, #f9fafb, #eef2ff);
    }

    .teacher-hw-item {
      padding: 12px 10px 10px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .teacher-hw-item:last-child { border-bottom: none; }

    .teacher-hw-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .teacher-hw-title { font-weight: 600; }

    .teacher-hw-meta { display: flex; flex-wrap: wrap; gap: 8px; color: #6b7280; }

    .link-button {
      border: none;
      background: transparent;
      padding: 0;
      font-size: 11px;
      color: #ef4444;
      cursor: pointer;
      text-decoration: underline;
      text-decoration-style: dotted;
    }

    .muted { font-size: 12px; color: #9ca3af; }

    .hidden { display: none !important; }

    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    /* Dark mode styles */
    [data-theme="dark"] body {
      background: radial-gradient(circle at top left, #0f172a, #1f2937 45%, #0f172a 90%);
    }

    [data-theme="dark"] .calendar {
      background: var(--card);
      border-color: var(--border);
    }

    [data-theme="dark"] .day-column {
      background: linear-gradient(180deg, #1f2937, #111827);
      border-color: rgba(59, 130, 246, 0.3);
    }

    [data-theme="dark"] .homework-card {
      background: #1f2937;
      color: var(--dark);
    }

    [data-theme="dark"] .field input,
    [data-theme="dark"] .field select,
    [data-theme="dark"] .field textarea {
      background: #111827;
      border-color: var(--border);
      color: var(--dark);
    }

    /* Search highlight */
    .search-highlight {
      background-color: #fef08a;
      padding: 2px 4px;
      border-radius: 3px;
    }

    [data-theme="dark"] .search-highlight {
      background-color: #78350f;
      color: #fef08a;
    }

    /* Stats panel */
    .stats-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .stat-card {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--blue);
      margin: 8px 0 4px;
    }

    .stat-label {
      font-size: 14px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Keyboard shortcut hint */
    .keyboard-hint {
      font-size: 11px;
      color: #9ca3af;
      margin-left: 8px;
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--card);
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      border-left: 4px solid var(--blue);
      z-index: 1000;
      animation: slideIn 0.3s ease;
      max-width: 400px;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    footer {
      margin-top: 30px;
      padding: 16px 32px 40px;
      text-align: center;
      font-size: 12px;
      color: #6b7280;
      position: relative;
    }

    .amsi-logo {
      position: fixed;
      bottom: 16px;
      right: 18px;
      width: 96px;
      opacity: 0.96;
      pointer-events: none;
      filter: drop-shadow(0 8px 18px rgba(15, 23, 42, 0.4));
    }

    /* Mobile "today" overlay */
    #todayOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    #todayOverlay.active { display: flex; }

    .today-panel {
      background: #ffffff;
      border-radius: 22px;
      max-width: 500px;
      width: calc(100% - 32px);
      max-height: 80vh;
      overflow-y: auto;
      padding: 16px 16px 18px;
      box-shadow: 0 25px 60px rgba(15, 23, 42, 0.45);
    }

    .today-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .today-panel-header h3 { margin: 0; font-size: 16px; }

    .today-panel-close {
      border: none;
      background: transparent;
      font-size: 20px;
      cursor: pointer;
      line-height: 1;
      padding: 4px 6px;
    }

    .today-panel-list { margin-top: 6px; }
    .today-panel-empty { font-size: 13px; color: #6b7280; }

    #mobileTodayBtn {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 82px;
      z-index: 35;
      display: none;
    }

    @media (max-width: 1024px) {
      .calendar-grid { grid-template-columns: repeat(4, minmax(240px, 1fr)); gap: 24px; }
      .teacher-layout { grid-template-columns: minmax(0, 1fr); gap: 32px; }
      main { max-width: 100%; padding: 0 32px 48px; }
    }

    @media (max-width: 900px) {
      header { grid-template-columns: 1fr; text-align: left; row-gap: 4px; padding: 10px 16px; }
      .meta { text-align: left; }
      main { margin-top: 22px; padding-inline: 16px; }
    }

    @media (max-width: 768px) {
      #mobileTodayBtn { display: inline-flex; }
      .calendar-grid { grid-template-columns: repeat(2, minmax(220px, 1fr)); gap: 20px; }
      .day-wrapper { min-width: 220px; }
      .amsi-logo { width: 72px; bottom: 10px; right: 10px; }
      main { padding: 0 20px 48px; }
      .calendar { padding: 24px 24px 28px; }
      #teacherPanel { padding: 24px 24px 28px; }
    }

    /* Print styles for PDF via browser (still usable) */
    @media print {
      body { background: #ffffff; }
      header { position: static; box-shadow: none; }
      #teacherPanel,
      #mobileTodayBtn,
      .amsi-logo,
      .controls-right button.btn-ghost { display: none !important; }
      main { max-width: 100%; margin: 0; padding: 0 12mm 12mm; }
      .calendar { box-shadow: none; border-radius: 0; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-area">
      <div class="logo-mark" aria-hidden="true"></div>
      <div class="logo-text">
        <div class="logo-main">Homework Planner</div>
        <div class="logo-sub">Arts &amp; Media School Islington</div>
      </div>
    </div>
    <div class="meta">
      <div id="currentWeek"></div>
      <div id="currentYear"></div>
    </div>
    <div class="controls">
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search homework..." class="search-input">
        <button id="toggleFiltersBtn" class="btn btn-light" title="Show filters">Show Filters ‚ñº</button>
      </div>
      <div id="advancedFilters" class="advanced-filters" style="display: none;">
        <div class="filter-row">
          <div class="filter-group">
            <label for="dueDateFrom">From:</label>
            <input type="date" id="dueDateFrom" class="date-input">
          </div>
          <div class="filter-group">
            <label for="dueDateTo">To:</label>
            <input type="date" id="dueDateTo" class="date-input">
          </div>
          <div class="filter-group">
            <label for="statusFilter">Status:</label>
            <select id="statusFilter" class="select-input">
              <option value="all">All Statuses</option>
              <option value="pending">Pending</option>
              <option value="completed">Completed</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="priorityFilter">Priority:</label>
            <select id="priorityFilter" class="select-input">
              <option value="all">All Priorities</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="tagFilter">Tags:</label>
            <select id="tagFilter" class="select-input" multiple>
              <option value="essay">Essay</option>
              <option value="reading">Reading</option>
              <option value="project">Project</option>
              <option value="presentation">Presentation</option>
              <option value="exam">Exam</option>
            </select>
          </div>
        </div>
      </div>
      <button id="themeToggle" class="btn btn-light" title="Toggle dark mode">üåô</button>
      <button id="statsBtn" class="btn btn-light" title="View statistics">üìä</button>
      <button id="exportBtn" class="btn btn-light" title="Export homework">üíæ Export</button>
      <input type="file" id="importFile" accept=".json" style="display: none;">
      <button id="importBtn" class="btn btn-light" title="Import homework">üì§ Import</button>
      <button id="teacherLoginBtn" class="btn btn-primary">Teacher Login</button>
    </div>
  </header>

  <main>
    <section class="calendar">
      <div class="controls-row">
        <div class="controls-left">
          <button class="btn btn-light" id="prevWeek">&laquo; Previous</button>
          <button class="btn" id="todayBtn">Today</button>
          <button class="btn btn-light" id="nextWeek">Next &raquo;</button>
        </div>

        <div class="year-filter" id="yearFilter">
          <button type="button" class="chip active" data-year="all">All years</button>
          <button type="button" class="chip" data-year="7">Yr7</button>
          <button type="button" class="chip" data-year="8">Yr8</button>
          <button type="button" class="chip" data-year="9">Yr9</button>
          <button type="button" class="chip" data-year="10">Yr10</button>
          <button type="button" class="chip" data-year="11">Yr11</button>
        </div>

        <div class="week-label" id="weekLabel">Week</div>

        <div class="controls-right">
          <label class="field" style="position: relative;">
            <span class="field-label">Search</span>
            <input type="search" id="searchInput" placeholder="Search homework..." style="width: 200px; padding-right: 32px;" />
            <span style="position: absolute; right: 8px; top: 28px; color: #9ca3af;">üîç</span>
          </label>
          <label class="field">
            <span class="field-label">Subject</span>
            <select id="subjectFilter">
              <option value="all">All subjects</option>
            </select>
          </label>
          <button class="btn btn-ghost" id="printBtn">Download PDF</button>
        </div>
      </div>

      <div class="calendar-grid" id="calendarGrid"></div>
      <p class="hint">
        Students do not need to log in. Choose the correct year group at the top and see homework for the selected week.
        Use <strong>Download PDF</strong> to export a text summary of this week's homework.
      </p>
    </section>

    <section id="teacherPanel">
      <div id="teacherLoggedOut">
        <h2>Teacher dashboard</h2>
        <p class="muted">Sign in with your school email and password from the homework system.</p>
        <form id="teacherLoginForm" class="card-form">
          <div class="form-grid">
            <label class="field">
              <span class="field-label">Email</span>
              <input type="email" name="email" required autocomplete="username" />
            </label>
            <label class="field">
              <span class="field-label">Password</span>
              <input type="password" name="password" required autocomplete="current-password" />
            </label>
          </div>
          <div class="form-actions">
            <button class="btn" type="submit">Sign in</button>
            <span id="loginStatus" class="status-text"></span>
          </div>
        </form>
      </div>

      <div id="teacherLoggedIn" class="hidden">
        <div class="teacher-header">
          <div>Logged in as <strong id="teacherIdentity"></strong></div>
          <button class="btn btn-light" id="logoutBtn">Sign out</button>
        </div>

        <div class="teacher-layout">
          <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <h3>Your homework <span id="homeworkCount" style="font-size: 14px; color: #6b7280;">(0)</span></h3>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-light" id="exportBtn" style="font-size: 12px; padding: 6px 12px;">Export</button>
                <button class="btn btn-light" id="importBtn" style="font-size: 12px; padding: 6px 12px;">Import</button>
              </div>
            </div>
            <div id="teacherHomeworkList" class="teacher-homework-list"></div>
          </div>
          <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <h3>Set new homework</h3>
              <button class="btn btn-light" id="templatesBtn" style="font-size: 12px; padding: 6px 12px;">Templates</button>
            </div>
            <form id="newHomeworkForm" class="card-form">
              <div class="form-grid">
                <label class="field">
                  <span class="field-label">Subject</span>
                  <input type="text" name="subject" placeholder="e.g. Mathematics" required />
                </label>
                <label class="field">
                  <span class="field-label">Class</span>
                  <input type="text" name="className" placeholder="e.g. 9Ma2" required />
                </label>
              </div>

              <div class="form-grid" style="margin-top: 10px;">
                <label class="field">
                  <span class="field-label">Year group</span>
                  <select name="yearGroup" required>
                    <option value="">Select year</option>
                    <option value="7">Year 7</option>
                    <option value="8">Year 8</option>
                    <option value="9">Year 9</option>
                    <option value="10">Year 10</option>
                    <option value="11">Year 11</option>
                  </select>
                </label>
                <div></div>
              </div>

              <label class="field">
                <span class="field-label">Title</span>
                <input type="text" name="title" placeholder="Short title students will see" required />
              </label>

              <label class="field">
                <span class="field-label">Description</span>
                <textarea name="description" rows="4" placeholder="Details, links, success criteria‚Ä¶" required></textarea>
              </label>

              <label class="field">
                <span class="field-label">Attachment / link (optional)</span>
                <input type="url" name="linkUrl" placeholder="https://... (Sparx, Google Classroom, etc.)" />
              </label>

              <div class="form-grid">
                <label class="field">
                  <span class="field-label">Estimated time (minutes)</span>
                  <input type="number" name="estimatedMinutes" min="5" step="5" value="30" required />
                </label>
                <label class="field">
                  <span class="field-label">Due date</span>
                  <input type="date" name="dueDate" required />
                </label>
              </div>

              <div class="form-actions">
                <button class="btn" type="submit">Set homework</button>
                <span id="newHwStatus" class="status-text"></span>
              </div>
            </form>
          </div>
        </div>
      </div>
    </section>

    <!-- Stats Panel Modal -->
    <div id="statsOverlay" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: none; align-items: center; justify-content: center;">
      <div style="background: var(--card); border-radius: 22px; padding: 32px; max-width: 800px; max-height: 90vh; overflow-y: auto; width: calc(100% - 32px);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h2 style="margin: 0;">Statistics Dashboard</h2>
          <button id="statsClose" style="background: transparent; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <div id="statsContent" class="stats-panel"></div>
      </div>
    </div>

    <!-- Edit Homework Modal -->
    <div id="editOverlay" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: none; align-items: center; justify-content: center;">
      <div style="background: var(--card); border-radius: 22px; padding: 32px; max-width: 600px; max-height: 90vh; overflow-y: auto; width: calc(100% - 32px);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h2 style="margin: 0;">Edit Homework</h2>
          <button id="editClose" style="background: transparent; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <form id="editHomeworkForm" class="card-form">
          <div class="form-grid">
            <label class="field">
              <span class="field-label">Subject</span>
              <input type="text" name="subject" required />
            </label>
            <label class="field">
              <span class="field-label">Class</span>
              <input type="text" name="className" required />
            </label>
          </div>
          <div class="form-grid" style="margin-top: 10px;">
            <label class="field">
              <span class="field-label">Year group</span>
              <select name="yearGroup" required>
                <option value="">Select year</option>
                <option value="7">Year 7</option>
                <option value="8">Year 8</option>
                <option value="9">Year 9</option>
                <option value="10">Year 10</option>
                <option value="11">Year 11</option>
              </select>
            </label>
            <div></div>
          </div>
          <label class="field">
            <span class="field-label">Title</span>
            <input type="text" name="title" required />
          </label>
          <label class="field">
            <span class="field-label">Description</span>
            <textarea name="description" rows="4" required></textarea>
          </label>
          <label class="field">
            <span class="field-label">Attachment / link (optional)</span>
            <input type="url" name="linkUrl" />
          </label>
          <div class="form-grid">
            <label class="field">
              <span class="field-label">Estimated time (minutes)</span>
              <input type="number" name="estimatedMinutes" min="5" step="5" value="30" required />
            </label>
            <label class="field">
              <span class="field-label">Due date</span>
              <input type="date" name="dueDate" required />
            </label>
          </div>
          <div class="form-actions">
            <button class="btn" type="submit">Save Changes</button>
            <span id="editHwStatus" class="status-text"></span>
          </div>
        </form>
      </div>
    </div>
  </main>

  <footer>
    &copy; <span id="yearSpan"></span> Arts &amp; Media School Islington. Coded by Arad Golbaghi.
  </footer>

  <!-- Logo (served from /public/images/amsi.png on Vercel or /images via Express locally) -->
  <img src="/images/amsi.png" alt="Arts &amp; Media School Islington logo" class="amsi-logo" />

  <!-- Mobile "Today" button -->
  <button class="btn" id="mobileTodayBtn">Today&apos;s homework</button>

  <!-- Today overlay -->
  <div id="todayOverlay">
    <div class="today-panel">
      <div class="today-panel-header">
        <h3>Today&apos;s homework</h3>
        <button class="today-panel-close" type="button" aria-label="Close">&times;</button>
      </div>
      <div class="today-panel-list" id="todayPanelList"></div>
    </div>
  </div>

  <!-- jsPDF for weekly PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    (function () {
      const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const monthShortNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

      const state = {
        allHomework: [],
        currentWeekStart: null,
        yearFilter: 'all',
        searchQuery: '',
        editHomeworkId: null,
        selectedHomework: new Set(),
      };

      const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';

      document.addEventListener('DOMContentLoaded', () => {
        setupDarkMode();
        setupWeekNavigation();
        setupTodayButton();
        setupYearFilter();
        setupSearch();
        setupStats();
        setupEditModal();
        setupKeyboardShortcuts();
        checkAuthStatus();
        
        // Set current year in footer
        document.getElementById('yearSpan').textContent = new Date().getFullYear();
        
        // Set default date range for filters (next 30 days)
        const today = new Date();
        const nextMonth = new Date();
        nextMonth.setDate(today.getDate() + 30);
        
        const formatDateForInput = (date) => {
          return date.toISOString().split('T')[0];
        };
        
        const dueDateFrom = $('dueDateFrom');
        const dueDateTo = $('dueDateTo');
        
        if (dueDateFrom) dueDateFrom.value = formatDateForInput(today);
        if (dueDateTo) dueDateTo.value = formatDateForInput(nextMonth);
        
        // Initialize filter state with default values
        filterState.dueDateFrom = today;
        filterState.dueDateTo = nextMonth;
        
        // Load homework data
        fetchHomework();
      });

      function $(id) { return document.getElementById(id); }

      function initWeek() {
        state.currentWeekStart = startOfWeek(new Date());
        updateWeekLabel();
      }

      function setupCalendarControls() {
        const prevBtn = $('prevWeek');
        const nextBtn = $('nextWeek');
        const todayBtn = $('todayBtn');
        const subjectFilter = $('subjectFilter');
        const printBtn = $('printBtn');

        if (prevBtn) prevBtn.addEventListener('click', () => shiftWeek(-1));
        if (nextBtn) nextBtn.addEventListener('click', () => shiftWeek(1));
        if (todayBtn) {
          todayBtn.addEventListener('click', () => {
            state.currentWeekStart = startOfWeek(new Date());
            updateWeekLabel();
            renderCalendar();
          });
        }

        if (subjectFilter) subjectFilter.addEventListener('change', renderCalendar);

        if (printBtn) {
          printBtn.addEventListener('click', () => {
            exportWeekPdf();
          });
        }

        const teacherToggle = $('teacherToggleBtn');
        const teacherPanel = $('teacherPanel');
        if (teacherToggle && teacherPanel) {
          teacherToggle.addEventListener('click', () => {
            teacherPanel.classList.toggle('active');
            teacherPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
          });
        }
      }

      function setupYearFilter() {
        const container = $('yearFilter');
        if (!container) return;
        container.addEventListener('click', (event) => {
          const btn = event.target.closest('button[data-year]');
          if (!btn) return;
          const year = btn.getAttribute('data-year');
          state.yearFilter = year;
          Array.from(container.querySelectorAll('button[data-year]')).forEach((b) => {
            b.classList.toggle('active', b === btn);
          });
          renderCalendar();
        });
      }

      function setupTodayOverlay() {
        const openBtn = $('mobileTodayBtn');
        const overlay = $('todayOverlay');
        const closeBtn = overlay && overlay.querySelector('.today-panel-close');
        const list = $('todayPanelList');

        if (!openBtn || !overlay || !list) return;

        openBtn.addEventListener('click', () => {
          buildTodayList();
          overlay.classList.add('active');
        });

        if (closeBtn) closeBtn.addEventListener('click', () => overlay.classList.remove('active'));
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) overlay.classList.remove('active');
        });
      }

      async function fetchHomework() {
        try {
          const res = await fetch('/api/homework', {
            credentials: 'include'
          });
          if (!res.ok) throw new Error('Network error');
          const data = await res.json();
          state.allHomework = Array.isArray(data) ? data : [];
        } catch (err) {
          console.warn('Error loading homework:', err);
          state.allHomework = isLocal ? demoHomework() : [];
        } finally {
          updateSubjectFilterOptions();
          renderCalendar();
        }
      }

      function demoHomework() {
        const today = stripTime(new Date());
        const d1 = new Date(today);
        d1.setDate(today.getDate() + 1);
        const d2 = new Date(today);
        d2.setDate(today.getDate() + 2);
        const d3 = new Date(today);
        d3.setDate(today.getDate() - 1);
        return [
          {
            id: 'demo1',
            subject: 'Mathematics',
            className: '9Ma2',
            yearGroup: '9',
            title: 'Algebra practice',
            description: 'Complete questions 1‚Äì12 in your exercise book.',
            estimatedMinutes: 60,
            dueDate: formatDateISO(d1),
            teacherEmail: 'maths.teacher@school.local',
            teacherName: 'Maths Teacher',
            linkUrl: 'https://example.com/sparx',
          },
          {
            id: 'demo2',
            subject: 'English',
            className: '8En1',
            yearGroup: '8',
            title: 'Reading response',
            description: 'Write a paragraph on the main character in chapter 3.',
            estimatedMinutes: 45,
            dueDate: formatDateISO(d2),
            teacherEmail: 'english.teacher@school.local',
            teacherName: 'English Teacher',
          },
          {
            id: 'demo3',
            subject: 'Science',
            className: '7Sc3',
            yearGroup: '7',
            title: 'Forces recap',
            description: 'Revise notes and complete worksheet.',
            estimatedMinutes: 30,
            dueDate: formatDateISO(d3),
            teacherEmail: 'science.teacher@school.local',
            teacherName: 'Science Teacher',
          },
        ];
      }

      function shiftWeek(offset) {
        const start = state.currentWeekStart;
        start.setDate(start.getDate() + offset * 7);
        state.currentWeekStart = start;
        updateWeekLabel();
        renderCalendar();
      }

      function updateWeekLabel() {
        const label = $('weekLabel');
        if (!label) return;
        const start = state.currentWeekStart;
        const end = new Date(start);
        end.setDate(start.getDate() + 6);
        const text = `${monthNames[start.getMonth()]} ${start.getDate()} ‚Äì ${end.getDate()} ${end.getFullYear()}`;
        label.textContent = text;
      }

      function renderCalendar() {
        const grid = $('calendarGrid');
        if (!grid) return;
        grid.innerHTML = '';

        const weekStart = state.currentWeekStart;
        const subjectFilter = ($('subjectFilter') && $('subjectFilter').value) || 'all';
        const today = stripTime(new Date());

        for (let i = 0; i < 7; i++) {
          const dayDate = new Date(weekStart);
          dayDate.setDate(weekStart.getDate() + i);

          const wrapper = document.createElement('div');
          wrapper.className = 'day-wrapper';

          const headerRow = document.createElement('div');
          headerRow.className = 'day-header-row';

          const nameEl = document.createElement('div');
          nameEl.className = 'day-header';
          nameEl.textContent = dayNames[i];

          const dateEl = document.createElement('div');
          dateEl.className = 'day-date';
          dateEl.textContent = `${dayDate.getDate()} ${monthShortNames[dayDate.getMonth()]}`;

          headerRow.appendChild(nameEl);
          headerRow.appendChild(dateEl);

          const column = document.createElement('div');
          column.className = 'day-column';

          const todaysHomework = state.allHomework
            .filter((hw) => {
              if (!hw.dueDate) return false;
              const due = parseDateISO(hw.dueDate);
              if (!isSameDay(due, dayDate)) return false;

              // Year group filter
              if (state.yearFilter !== 'all') {
                const yg = hw.yearGroup != null ? String(hw.yearGroup) : '';
                if (yg !== state.yearFilter) return false;
              }

              // Subject filter
              if (subjectFilter !== 'all') {
                const s = (hw.subject || '').toLowerCase();
                if (s !== subjectFilter.toLowerCase()) return false;
              }

              // Search query filter
              if (filterState.searchQuery) {
                const searchLower = filterState.searchQuery.toLowerCase();
                const matchesTitle = (hw.title || '').toLowerCase().includes(searchLower);
                const matchesSubject = (hw.subject || '').toLowerCase().includes(searchLower);
                const matchesDesc = (hw.description || '').toLowerCase().includes(searchLower);
                if (!matchesTitle && !matchesSubject && !matchesDesc) return false;
              }

              // Status filter
              if (filterState.status !== 'all') {
                const isCompleted = hw.completed || false;
                if (filterState.status === 'completed' && !isCompleted) return false;
                if (filterState.status === 'pending' && isCompleted) return false;
              }

              // Priority filter
              if (filterState.priority !== 'all' && hw.priority) {
                if (hw.priority.toLowerCase() !== filterState.priority.toLowerCase()) return false;
              }

              // Tags filter
              if (filterState.tags.length > 0) {
                const hwTags = Array.isArray(hw.tags) ? hw.tags : [];
                const hasMatchingTag = filterState.tags.some(tag => 
                  hwTags.some(t => t.toLowerCase() === tag.toLowerCase())
                );
                if (!hasMatchingTag) return false;
              }

              return true;
            })
            .sort((a, b) => {
              const ca = (a.className || '').localeCompare(b.className || '');
              if (ca !== 0) return ca;
              return (a.title || '').localeCompare(b.title || '');
            });

          if (todaysHomework.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'empty-day';
            empty.textContent = 'No homework set';
            column.appendChild(empty);
          } else {
            todaysHomework.forEach((hw) => {
              column.appendChild(renderHomeworkCard(hw, today));
            });
          }

          wrapper.appendChild(headerRow);
          wrapper.appendChild(column);
          grid.appendChild(wrapper);
        }
      }

      function renderHomeworkCard(hw, today) {
        const card = document.createElement('article');
        card.className = 'homework-card';

        const subjectEl = document.createElement('div');
        subjectEl.className = 'homework-subject';
        const subject = hw.subject || 'Subject';
        const cls = hw.className || '';
        const yg = hw.yearGroup ? ` ¬∑ Yr${hw.yearGroup}` : '';
        subjectEl.textContent = cls ? `${subject} ¬∑ ${cls}${yg}` : subject + yg;

        const titleEl = document.createElement('div');
        titleEl.className = 'homework-title';
        titleEl.textContent = hw.title || 'Homework';

        const metaEl = document.createElement('div');
        metaEl.className = 'homework-meta';
        const parts = [];
        if (hw.estimatedMinutes) parts.push(`‚è± ${hw.estimatedMinutes} min`);
        if (hw.teacherName || hw.teacherEmail) parts.push(`üë©‚Äçüè´ ${hw.teacherName || hw.teacherEmail}`);
        if (hw.dueDate) parts.push(`üìÖ Due ${hw.dueDate}`);
        metaEl.textContent = parts.join(' ¬∑ ');

        card.appendChild(subjectEl);
        card.appendChild(titleEl);
        card.appendChild(metaEl);

        if (hw.description) {
          const descEl = document.createElement('p');
          descEl.className = 'homework-description';
          descEl.textContent = hw.description;
          descEl.title = 'Click to expand description';
          descEl.addEventListener('click', function() {
            this.classList.toggle('expanded');
            if (this.classList.contains('expanded')) {
              this.title = 'Click to collapse';
            } else {
              this.title = 'Click to expand description';
            }
          });
          card.appendChild(descEl);
        }

        if (hw.linkUrl) {
          const linkWrap = document.createElement('div');
          linkWrap.className = 'homework-link';
          const a = document.createElement('a');
          a.href = hw.linkUrl;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.textContent = 'Open task';
          linkWrap.appendChild(a);
          card.appendChild(linkWrap);
        }

        if (hw.dueDate) {
          const pill = document.createElement('div');
          pill.className = 'status-pill';
          const due = parseDateISO(hw.dueDate);
          const diffDays = Math.round((stripTime(due) - today) / (1000 * 60 * 60 * 24));

          if (diffDays < 0) {
            pill.textContent = 'Overdue';
            pill.classList.add('status-overdue');
          } else if (diffDays === 0) {
            pill.textContent = 'Due today';
            pill.classList.add('status-today');
          } else if (diffDays <= 2) {
            pill.textContent = 'Due soon';
            pill.classList.add('status-soon');
          } else {
            pill.textContent = 'Upcoming';
            pill.classList.add('status-upcoming');
          }
          card.appendChild(pill);
        }

        return card;
      }

      function buildTodayList() {
        const list = $('todayPanelList');
        if (!list) return;
        list.innerHTML = '';

        const subjectFilter = ($('subjectFilter') && $('subjectFilter').value) || 'all';
        const today = stripTime(new Date());

        const items = state.allHomework
          .filter((hw) => {
            if (!hw.dueDate) return false;
            const due = parseDateISO(hw.dueDate);
            if (!isSameDay(due, today)) return false;
            if (state.yearFilter !== 'all') {
              const yg = hw.yearGroup != null ? String(hw.yearGroup) : '';
              if (yg !== state.yearFilter) return false;
            }
            if (subjectFilter !== 'all') {
              const s = (hw.subject || '').toLowerCase();
              if (s !== subjectFilter.toLowerCase()) return false;
            }
            return true;
          })
          .sort((a, b) => (a.subject || '').localeCompare(b.subject || ''));

        if (!items.length) {
          const p = document.createElement('p');
          p.className = 'today-panel-empty';
          p.textContent = 'No homework due today for the selected filters.';
          list.appendChild(p);
          return;
        }

        items.forEach((hw) => {
          const card = renderHomeworkCard(hw, today);
          card.style.marginBottom = '10px';
          list.appendChild(card);
        });
      }

      function startOfWeek(date) {
        const d = stripTime(date);
        const day = d.getDay();
        const diff = day === 0 ? -6 : 1 - day; // Monday start
        d.setDate(d.getDate() + diff);
        return d;
      }

      function stripTime(date) {
        return new Date(date.getFullYear(), date.getMonth(), date.getDate());
      }

      function isSameDay(a, b) {
        return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
      }

      function parseDateISO(str) {
        const parts = (str || '').split('-').map(Number);
        if (parts.length < 3 || !parts[0]) return new Date(str);
        return new Date(parts[0], parts[1] - 1, parts[2]);
      }

      function formatDateISO(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      }

      function updateSubjectFilterOptions() {
        const select = $('subjectFilter');
        if (!select) return;
        const prev = select.value || 'all';
        const subjects = Array.from(
          new Set(
            state.allHomework.map((hw) => (hw.subject || '').trim()).filter(Boolean)
          )
        ).sort();
        select.innerHTML = '';
        const allOpt = document.createElement('option');
        allOpt.value = 'all';
        allOpt.textContent = 'All subjects';
        select.appendChild(allOpt);
        subjects.forEach((sub) => {
          const opt = document.createElement('option');
          opt.value = sub;
          opt.textContent = sub;
          select.appendChild(opt);
        });
        if (subjects.includes(prev)) select.value = prev;
      }

      function exportWeekPdf() {
        if (!window.jspdf || !window.jspdf.jsPDF) {
          alert('PDF generator not loaded. Check your internet connection and try again.');
          return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

        const marginLeft = 12;
        let y = 14;

        const weekStart = state.currentWeekStart;
        const weekLabelEl = $('weekLabel');
        const weekLabelText = weekLabelEl ? weekLabelEl.textContent : '';
        const subjectFilterEl = $('subjectFilter');
        const subjectFilterValue = subjectFilterEl ? subjectFilterEl.value : 'all';

        doc.setFontSize(14);
        doc.text('Arts & Media School Islington ‚Äì Homework Planner', marginLeft, y);
        y += 7;

        doc.setFontSize(11);
        if (weekLabelText) {
          doc.text(weekLabelText, marginLeft, y);
          y += 5;
        }

        const yearLabel = state.yearFilter === 'all' ? 'All years' : 'Year ' + state.yearFilter;
        const subjLabel = subjectFilterValue === 'all' ? 'All subjects' : subjectFilterValue;
        doc.text(`Filters: ${yearLabel} ¬∑ ${subjLabel}`, marginLeft, y);
        y += 8;

        doc.setFontSize(10);
        const today = stripTime(new Date());

        for (let i = 0; i < 7; i++) {
          const dayDate = new Date(weekStart);
          dayDate.setDate(weekStart.getDate() + i);

          if (y > 190) {
            doc.addPage();
            y = 14;
          }

          const dayHeader = `${dayNames[i]} ${dayDate.getDate()} ${monthShortNames[dayDate.getMonth()]}`;
          doc.setFont(undefined, 'bold');
          doc.text(dayHeader, marginLeft, y);
          y += 5;
          doc.setFont(undefined, 'normal');

          const subjectFilter = subjectFilterValue;

          const todaysHomework = state.allHomework
            .filter((hw) => {
              if (!hw.dueDate) return false;
              const due = parseDateISO(hw.dueDate);
              if (!isSameDay(due, dayDate)) return false;

              // Year group filter
              if (state.yearFilter !== 'all') {
                const yg = hw.yearGroup != null ? String(hw.yearGroup) : '';
                if (yg !== state.yearFilter) return false;
              }

              // Subject filter
              if (subjectFilter !== 'all') {
                const s = (hw.subject || '').toLowerCase();
                if (s !== subjectFilter.toLowerCase()) return false;
              }

              // Search query filter
              if (filterState.searchQuery) {
                const searchLower = filterState.searchQuery.toLowerCase();
                const matchesTitle = (hw.title || '').toLowerCase().includes(searchLower);
                const matchesSubject = (hw.subject || '').toLowerCase().includes(searchLower);
                const matchesDesc = (hw.description || '').toLowerCase().includes(searchLower);
                if (!matchesTitle && !matchesSubject && !matchesDesc) return false;
              }

              // Status filter
              if (filterState.status !== 'all') {
                const isCompleted = hw.completed || false;
                if (filterState.status === 'completed' && !isCompleted) return false;
                if (filterState.status === 'pending' && isCompleted) return false;
              }

              // Priority filter
              if (filterState.priority !== 'all' && hw.priority) {
                if (hw.priority.toLowerCase() !== filterState.priority.toLowerCase()) return false;
              }

              // Tags filter
              if (filterState.tags.length > 0) {
                const hwTags = Array.isArray(hw.tags) ? hw.tags : [];
                const hasMatchingTag = filterState.tags.some(tag => 
                  hwTags.some(t => t.toLowerCase() === tag.toLowerCase())
                );
                if (!hasMatchingTag) return false;
              }

              return true;
            })
            .sort((a, b) => {
              const ca = (a.className || '').localeCompare(b.className || '');
              if (ca !== 0) return ca;
              return (a.title || '').localeCompare(b.title || '');
            });

          if (!todaysHomework.length) {
            doc.text('- No homework set', marginLeft + 4, y);
            y += 4;
            continue;
          }

          todaysHomework.forEach((hw) => {
            if (y > 190) {
              doc.addPage();
              y = 14;
            }

            const main = (hw.subject || 'Subject') +
              (hw.className ? ' ¬∑ ' + hw.className : '') +
              (hw.yearGroup ? ' ¬∑ Yr' + hw.yearGroup : '');
            doc.text('‚Ä¢ ' + main, marginLeft + 2, y);
            y += 4;

            const metaParts = [];
            if (hw.estimatedMinutes) metaParts.push(`${hw.estimatedMinutes} min`);
            if (hw.teacherName || hw.teacherEmail) metaParts.push(hw.teacherName || hw.teacherEmail);
            if (hw.linkUrl) metaParts.push('Link: ' + hw.linkUrl);

            if (metaParts.length) {
              const metaLine = '   ' + metaParts.join(' ¬∑ ');
              const metaWrapped = doc.splitTextToSize(metaLine, 270);
              metaWrapped.forEach((line) => {
                if (y > 190) {
                  doc.addPage();
                  y = 14;
                }
                doc.text(line, marginLeft + 2, y);
                y += 4;
              });
            }

            if (hw.description) {
              const desc = '   ' + hw.description;
              const descWrapped = doc.splitTextToSize(desc, 270);
              descWrapped.forEach((line) => {
                if (y > 190) {
                  doc.addPage();
                  y = 14;
                }
                doc.text(line, marginLeft + 2, y);
                y += 4;
              });
            }

            y += 1;
          });

          y += 3;
        }

        const fileName = `Homework_${formatDateISO(weekStart)}.pdf`;
        doc.save(fileName);
      }

      // Teacher auth + dashboard
      function setupTeacherAuth() {
        const loginForm = $('teacherLoginForm');
        const loggedOut = $('teacherLoggedOut');
        const loggedIn = $('teacherLoggedIn');
        const identity = $('teacherIdentity');
        const loginStatus = $('loginStatus');
        const newHwStatus = $('newHwStatus');

        if (!loginForm) return;

        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          console.log('Login form submitted');
          
          if (loginStatus) {
            loginStatus.textContent = 'Signing in‚Ä¶';
            loginStatus.classList.remove('error');
          }
          
          try {
            const email = loginForm.email.value.trim();
            const password = loginForm.password.value;
            
            console.log('Attempting login with email:', email);
            
            if (!email || !password) {
              throw new Error('Email and password are required');
            }
            
            const response = await fetch('/api/login', {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
              },
              credentials: 'include', // Important for cookies
              body: JSON.stringify({ email, password }),
            });
            
            console.log('Response status:', response.status);
            console.log('Response headers:', Object.fromEntries(response.headers.entries()));
            
            let data;
            try {
              data = await response.json();
              console.log('Response data:', data);
            } catch (parseErr) {
              console.error('Failed to parse response:', parseErr);
              const text = await response.text();
              console.error('Response text:', text);
              throw new Error('Invalid response from server');
            }
            
            if (!response.ok) {
              throw new Error(data.error || `Login failed (${response.status})`);
            }
            
            if (!data.success && !data.teacherEmail) {
              throw new Error('Invalid response from server');
            }
            
            console.log('Login successful!');
            
            // Update UI
            if (loggedOut) loggedOut.classList.add('hidden');
            if (loggedIn) loggedIn.classList.remove('hidden');
            if (identity) {
              identity.textContent = data.teacherName || data.teacherEmail || data.email || email;
            }
            if (loginStatus) {
              loginStatus.textContent = 'Signed in successfully ‚úì';
              loginStatus.classList.remove('error');
              setTimeout(() => {
                if (loginStatus) loginStatus.textContent = '';
              }, 2000);
            }
            loginForm.reset();
            
            // Load teacher's homework
            await loadTeacherHomework();
            
          } catch (err) {
            console.error('Login error:', err);
            if (loginStatus) {
              loginStatus.textContent = err.message || 'Could not sign in. Please try again.';
              loginStatus.classList.add('error');
            }
          }
        });

        const logoutBtn = $('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', async () => {
            try { 
              await fetch('/api/logout', { method: 'POST', credentials: 'include' }); 
            } catch (e) {
              console.error('Logout error:', e);
            }
            if (loggedIn) loggedIn.classList.add('hidden');
            if (loggedOut) loggedOut.classList.remove('hidden');
            const list = $('teacherHomeworkList');
            if (list) list.innerHTML = '';
          });
        }

        // Check if already logged in on page load
        checkAuthStatus();

        const newHwForm = $('newHomeworkForm');
        if (newHwForm) {
          newHwForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (newHwStatus) {
              newHwStatus.textContent = 'Saving‚Ä¶';
              newHwStatus.classList.remove('error');
            }
            try {
              const payload = {
                subject: newHwForm.subject.value.trim(),
                className: newHwForm.className.value.trim(),
                yearGroup: newHwForm.yearGroup.value,
                title: newHwForm.title.value.trim(),
                description: newHwForm.description.value.trim(),
                estimatedMinutes: Number(newHwForm.estimatedMinutes.value),
                dueDate: newHwForm.dueDate.value,
                linkUrl: newHwForm.linkUrl.value.trim() || null,
              };
              const res = await fetch('/api/homework', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(payload),
              });
              if (!res.ok) {
                throw new Error(res.status === 401 ? 'Please sign in again' : 'Could not save homework');
              }
              const saved = await res.json();
              state.allHomework.push(saved);
              updateSubjectFilterOptions();
              renderCalendar();
              await loadTeacherHomework();
              newHwForm.reset();
              newHwForm.estimatedMinutes.value = 30;
              if (newHwStatus) {
                newHwStatus.textContent = 'Homework set ‚úî';
                setTimeout(() => { newHwStatus.textContent = ''; }, 2500);
              }
            } catch (err) {
              if (newHwStatus) {
                newHwStatus.textContent = err.message || 'Error saving homework';
                newHwStatus.classList.add('error');
              }
            }
          });
        }
      }

      async function checkAuthStatus() {
        try {
          const res = await fetch('/api/check-auth', {
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
          });
          const data = await res.json();
          if (data.authenticated) {
            const loggedOut = $('teacherLoggedOut');
            const loggedIn = $('teacherLoggedIn');
            const identity = $('teacherIdentity');
            if (loggedOut) loggedOut.classList.add('hidden');
            if (loggedIn) loggedIn.classList.remove('hidden');
            if (identity) {
              identity.textContent = data.teacherName || data.teacherEmail || '';
            }
            const statsBtn = $('statsBtn');
            if (statsBtn) statsBtn.style.display = 'inline-flex';
            await loadTeacherHomework();
          } else {
            const statsBtn = $('statsBtn');
            if (statsBtn) statsBtn.style.display = 'none';
          }
        } catch (err) {
          console.log('Not authenticated or error checking auth:', err);
          const statsBtn = $('statsBtn');
          if (statsBtn) statsBtn.style.display = 'none';
        }
      }

      async function loadTeacherHomework() {
        const list = $('teacherHomeworkList');
        const identity = $('teacherIdentity');
        if (!list) return;
        try {
          console.log('Loading teacher homework...');
          const res = await fetch('/api/my-homework', {
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          console.log('My homework response status:', res.status);
          
          if (!res.ok) {
            if (res.status === 401) {
              console.log('Not authenticated, showing empty list');
              list.innerHTML = '<p class="muted">Please sign in to see your homework.</p>';
              return;
            }
            list.innerHTML = '<p class="muted">No homework yet ‚Äì set your first task on the right.</p>';
            return;
          }
          const data = await res.json();
          console.log('My homework data:', data);
          const items = Array.isArray(data) ? data : (data.items || []);
          if (identity && data.teacherName) {
            identity.textContent = data.teacherName || data.teacherEmail || identity.textContent;
          }
          list.innerHTML = '';
          if (!items.length) {
            list.innerHTML = '<p class="muted">No homework yet ‚Äì set your first task on the right.</p>';
            return;
          }
          items
            .slice()
            .sort((a, b) => (a.dueDate || '').localeCompare(b.dueDate || ''))
            .forEach((hw) => {
              const row = document.createElement('div');
              row.className = 'teacher-hw-item';

              const header = document.createElement('div');
              header.className = 'teacher-hw-header-row';

              const titleSpan = document.createElement('span');
              titleSpan.className = 'teacher-hw-title';
              titleSpan.textContent = hw.title || '';

              const editBtn = document.createElement('button');
              editBtn.className = 'link-button';
              editBtn.type = 'button';
              editBtn.textContent = 'Edit';
              editBtn.style.color = 'var(--blue)';
              editBtn.style.marginRight = '8px';
              editBtn.addEventListener('click', () => openEditModal(hw));

              const deleteBtn = document.createElement('button');
              deleteBtn.className = 'link-button';
              deleteBtn.type = 'button';
              deleteBtn.textContent = 'Delete';
              deleteBtn.addEventListener('click', () => handleDeleteHomework(hw.id));

              const btnContainer = document.createElement('div');
              btnContainer.style.display = 'flex';
              btnContainer.style.gap = '8px';
              btnContainer.appendChild(editBtn);
              btnContainer.appendChild(deleteBtn);

              header.appendChild(titleSpan);
              header.appendChild(btnContainer);

              const meta = document.createElement('div');
              meta.className = 'teacher-hw-meta';
              const bits = [];
              if (hw.subject) bits.push(hw.subject);
              if (hw.className) bits.push(hw.className);
              if (hw.yearGroup) bits.push('Yr' + hw.yearGroup);
              if (hw.dueDate) bits.push('Due ' + hw.dueDate);
              if (hw.linkUrl) bits.push('Has link');
              meta.textContent = bits.join(' ¬∑ ');

              row.appendChild(header);
              row.appendChild(meta);
              list.appendChild(row);
            });
            updateHomeworkCount();
        } catch (err) {
          console.error(err);
          list.innerHTML = '<p class="muted">Could not load your homework. Check the server console.</p>';
          updateHomeworkCount();
        }
      }

      async function handleDeleteHomework(id) {
        if (!id) return;
        const confirmed = window.confirm('Delete this homework? Students will no longer see it.');
        if (!confirmed) return;
        try {
          const res = await fetch('/api/homework/' + encodeURIComponent(id), { 
            method: 'DELETE',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            throw new Error(errorData.error || (res.status === 403 ? 'You can only delete homework you set.' : 'Could not delete homework.'));
          }
          state.allHomework = state.allHomework.filter((hw) => hw.id !== id);
          await loadTeacherHomework();
          renderCalendar();
        } catch (err) {
          alert(err.message || 'Error deleting homework');
        }
      }

      // NEW FEATURES IMPLEMENTATION

      // Dark Mode
      function setupDarkMode() {
        const toggle = $('darkModeToggle');
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        toggle.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

        toggle.addEventListener('click', () => {
          const current = document.documentElement.getAttribute('data-theme');
          const newTheme = current === 'dark' ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
          toggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        });
      }

      // Search and Filter State
      const filterState = {
        searchQuery: '',
        dueDateFrom: null,
        dueDateTo: null,
        status: 'all', // all, completed, pending
        priority: 'all', // all, high, medium, low
        tags: []
      };

      // Search and Filter Functionality
      function setupSearch() {
        const searchInput = $('searchInput');
        const dueDateFrom = $('dueDateFrom');
        const dueDateTo = $('dueDateTo');
        const statusFilter = $('statusFilter');
        const priorityFilter = $('priorityFilter');
        const tagFilter = $('tagFilter');
        const advancedFilters = $('advancedFilters');
        const toggleFiltersBtn = $('toggleFiltersBtn');

        // Toggle advanced filters
        if (toggleFiltersBtn) {
          toggleFiltersBtn.addEventListener('click', () => {
            const isVisible = advancedFilters.classList.toggle('visible');
            toggleFiltersBtn.textContent = isVisible ? 'Hide Filters ‚ñ≤' : 'Show Filters ‚ñº';
            renderCalendar();
          });
        }

        // Search input handler
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            filterState.searchQuery = e.target.value.toLowerCase().trim();
            renderCalendar();
          });
        }

        // Date range filters
        if (dueDateFrom) {
          dueDateFrom.addEventListener('change', (e) => {
            filterState.dueDateFrom = e.target.value ? new Date(e.target.value) : null;
            renderCalendar();
          });
        }

        if (dueDateTo) {
          dueDateTo.addEventListener('change', (e) => {
            filterState.dueDateTo = e.target.value ? new Date(e.target.value) : null;
            renderCalendar();
          });
        }

        // Status filter
        if (statusFilter) {
          statusFilter.addEventListener('change', (e) => {
            filterState.status = e.target.value;
            renderCalendar();
          });
        }

        // Priority filter
        if (priorityFilter) {
          priorityFilter.addEventListener('change', (e) => {
            filterState.priority = e.target.value;
            renderCalendar();
          });
        }

        // Tags filter (multi-select)
        if (tagFilter) {
          tagFilter.addEventListener('change', (e) => {
            const selected = Array.from(tagFilter.selectedOptions).map(opt => opt.value);
            filterState.tags = selected;
            renderCalendar();
          });
        }
      }

      // Statistics Dashboard
      function setupStats() {
        const statsBtn = $('statsBtn');
        const statsOverlay = $('statsOverlay');
        const statsClose = $('statsClose');
        const statsContent = $('statsContent');

        if (!statsBtn || !statsOverlay) return;

        statsBtn.addEventListener('click', async () => {
          try {
            const res = await fetch('/api/stats', { credentials: 'include' });
            if (!res.ok) return;
            const stats = await res.json();
            
            statsContent.innerHTML = `
              <div class="stat-card">
                <div class="stat-label">Total Homework</div>
                <div class="stat-value">${stats.total}</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Overdue</div>
                <div class="stat-value" style="color: var(--red);">${stats.overdue}</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Due Today</div>
                <div class="stat-value" style="color: var(--orange);">${stats.dueToday}</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Due This Week</div>
                <div class="stat-value">${stats.dueThisWeek}</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Total Time</div>
                <div class="stat-value">${Math.round(stats.totalEstimatedMinutes / 60)}h</div>
              </div>
            `;
            
            statsOverlay.style.display = 'flex';
          } catch (err) {
            console.error('Stats error:', err);
          }
        });

        if (statsClose) statsClose.addEventListener('click', () => {
          statsOverlay.style.display = 'none';
        });
        statsOverlay.addEventListener('click', (e) => {
          if (e.target === statsOverlay) statsOverlay.style.display = 'none';
        });
      }

      // Edit Homework Modal
      function setupEditModal() {
        const editOverlay = $('editOverlay');
        const editClose = $('editClose');
        const editForm = $('editHomeworkForm');

        if (editClose) editClose.addEventListener('click', () => {
          editOverlay.style.display = 'none';
        });
        if (editOverlay) editOverlay.addEventListener('click', (e) => {
          if (e.target === editOverlay) editOverlay.style.display = 'none';
        });

        if (editForm) {
          editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!state.editHomeworkId) return;
            
            const statusEl = $('editHwStatus');
            if (statusEl) {
              statusEl.textContent = 'Saving...';
              statusEl.classList.remove('error');
            }

            try {
              const payload = {
                title: editForm.title.value.trim(),
                description: editForm.description.value.trim(),
                subject: editForm.subject.value.trim(),
                className: editForm.className.value.trim(),
                yearGroup: editForm.yearGroup.value,
                estimatedMinutes: Number(editForm.estimatedMinutes.value),
                dueDate: editForm.dueDate.value,
                linkUrl: editForm.linkUrl.value.trim() || null,
              };

              const res = await fetch(`/api/homework/${state.editHomeworkId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(payload),
              });

              if (!res.ok) throw new Error('Failed to update homework');
              
              if (statusEl) {
                statusEl.textContent = 'Updated successfully ‚úì';
                setTimeout(() => statusEl.textContent = '', 2000);
              }
              
              editOverlay.style.display = 'none';
              await fetchHomework();
              await loadTeacherHomework();
            } catch (err) {
              if (statusEl) {
                statusEl.textContent = err.message || 'Error updating homework';
                statusEl.classList.add('error');
              }
            }
          });
        }
      }

      function openEditModal(hw) {
        state.editHomeworkId = hw.id;
        const editOverlay = $('editOverlay');
        const editForm = $('editHomeworkForm');
        
        if (!editOverlay || !editForm) return;

        editForm.subject.value = hw.subject || '';
        editForm.className.value = hw.className || '';
        editForm.yearGroup.value = hw.yearGroup || '';
        editForm.title.value = hw.title || '';
        editForm.description.value = hw.description || '';
        editForm.linkUrl.value = hw.linkUrl || '';
        editForm.estimatedMinutes.value = hw.estimatedMinutes || 30;
        editForm.dueDate.value = hw.dueDate || '';

        editOverlay.style.display = 'flex';
      }

      // Keyboard Shortcuts
      function setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
          
          if (e.key === 'n' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            $('newHomeworkForm')?.scrollIntoView({ behavior: 'smooth' });
          }
          if (e.key === '/' || (e.key === 'f' && (e.ctrlKey || e.metaKey))) {
            e.preventDefault();
            $('searchInput')?.focus();
          }
          if (e.key === 't' && !e.ctrlKey && !e.metaKey) {
            e.preventDefault();
            $('todayBtn')?.click();
          }
          if (e.key === 'ArrowLeft' && e.altKey) {
            e.preventDefault();
            $('prevWeek')?.click();
          }
          if (e.key === 'ArrowRight' && e.altKey) {
            e.preventDefault();
            $('nextWeek')?.click();
          }
        });
      }

      // Loading States Helper
      function setLoading(element, loading) {
        if (!element) return;
        if (loading) {
          element.classList.add('loading');
          element.disabled = true;
        } else {
          element.classList.remove('loading');
          element.disabled = false;
        }
      }

      // Toast Notification
      function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.style.borderLeftColor = type === 'error' ? 'var(--red)' : type === 'success' ? 'var(--green)' : 'var(--blue)';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'slideIn 0.3s ease reverse';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // Search filtering is handled in renderCalendar function below

      // Export functionality
      async function exportHomework() {
        try {
          const res = await fetch('/api/export', { credentials: 'include' });
          if (!res.ok) throw new Error('Export failed');
          const data = await res.json();
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `homework-export-${Date.now()}.json`;
          a.click();
          URL.revokeObjectURL(url);
          showToast('Homework exported successfully!', 'success');
        } catch (err) {
          showToast('Export failed: ' + err.message, 'error');
        }
      }

      // Wire up export/import buttons
      const exportBtn = $('exportBtn');
      const importBtn = $('importBtn');
      if (exportBtn) exportBtn.addEventListener('click', exportHomework);
      if (importBtn) {
        importBtn.addEventListener('click', () => {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
              const text = await file.text();
              const data = JSON.parse(text);
              const res = await fetch('/api/import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ homework: Array.isArray(data) ? data : [data] }),
              });
              if (!res.ok) throw new Error('Import failed');
              showToast('Homework imported successfully!', 'success');
              await fetchHomework();
              await loadTeacherHomework();
            } catch (err) {
              showToast('Import failed: ' + err.message, 'error');
            }
          };
          input.click();
        });
      }

      // Update homework count
      function updateHomeworkCount() {
        const count = document.querySelectorAll('.teacher-hw-item').length;
        const countEl = $('homeworkCount');
        if (countEl) countEl.textContent = `(${count})`;
      }

      // Update checkAuthStatus to show stats button
      const originalCheckAuthStatus = window.checkAuthStatus;
      if (originalCheckAuthStatus) {
        window.checkAuthStatus = async function() {
          await originalCheckAuthStatus();
          const statsBtn = $('statsBtn');
          try {
            const res = await fetch('/api/check-auth', { credentials: 'include' });
            const data = await res.json();
            if (statsBtn) statsBtn.style.display = data.authenticated ? 'inline-flex' : 'none';
          } catch (err) {
            if (statsBtn) statsBtn.style.display = 'none';
          }
        };
      }
    })();
  </script>
</body>
</html>
